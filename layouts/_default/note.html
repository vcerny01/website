<!DOCTYPE html>
<html lang="{{.Site.LanguageCode}}">
{{$title := ""}}
{{if .Params.title}}{{$title = .Params.title}}{{else}}{{$title = .File.BaseFileName}}{{end}}

<head>
    {{partial "meta-head" .}}
    {{partial "default-style.html" .}}
    <link rel='stylesheet' type='text/css' href="/css/note.css">
    {{partial "favicon.html" .}}
    <title>{{$title}}</title>
    {{if .Params.math}}
        {{partial "math.html" .}}
    {{end}}
</head> 

{{$disable_toc := .Params.disable_toc}}
{{if .Params.source}}
    {{$disable_toc = true}}
{{end}}

<body>
    <header>
        {{partial "partials/navbar.html" .}}
        <h1>{{$title}}</h1>
    </header>
    <div class="meta-container">
        <!-- Series, date metadata -->
        <div class="metadata" {{if $disable_toc}} style="margin: 0 auto; float: none; margin-bottom: 20px; padding: 10px;"{{end}}>
            {{if or (.Params.series) (.Params.date)}}
                {{if .Params.series}}
                    <div><span>Series:</span> <a href="/notes/{{if in .File.Path "kvinta"}}kvinta/{{end}}{{.Params.series | urlize}}">{{.Params.series}}</a></div>
                {{end}}
                {{if .Params.date}}
                    <div style="padding-top: 3px;"><span>Last updated:</span> {{ time.Format "Jan 2, 2006" .Params.date}}</div>
                {{end}}
            {{end}}
        </div>
            <!-- Table of Contents -->
            {{if not $disable_toc}}
                {{partial "partials/toc.html" .}}
            {{end}}
    </div>
    <div>
        <!-- Cover -->
        {{if .Params.cover}}
            <a href="/notes/{{.Params.source}}"><img src="{{.Params.cover}}" class="cover"></a>
        {{end}}
    </div>
    <article>
        
        {{$relDir := replace .RelPermalink (printf "%s/" (.File.BaseFileName | urlize)) ""}}
        {{$content := .Content}}
        
        {{/* MAKE HIGHLIGHTS */}}
        {{$highlights := findRE "==(.*?)==" .Content}}
        {{range $highlights}}
            {{$text := (replace . "==" "")}}
            {{$content = (replace $content . (printf "%s%s%s" "<mark>" $text "</mark>"))}}
        {{end}}

        {{/* MAKE IMAGE WIKILINKS */}}
        {{$images := findRE "\\!\\[\\[(.*?)\\]\\]" .Content}}
        {{range $images}}
            {{$imageFileName := (replace (replace (replace . "[[" "") "]]" "") "!" "")}}
            {{$content = replace $content . (printf "%s%s%s" "<img src=\"/notes/assets/" $imageFileName "\">")}}
        {{end}}

        {{/* MAKE WIKILINKS */}}
        {{$wikilinks := findRE "\\[\\[(.*?)\\]\\]" .Content}}
        {{range $wikilinks}}
            {{if gt (len (split . "|")) 1}}
                {{$alias := split (replace (replace . "[[" "") "]]" "") "|"}}
                {{$content = replace $content . (printf "%s%s%s%s%s%s" "<a href=\"" "/notes/" ((index $alias 0) | urlize) "\">" (index $alias 1 ) "</a>")}}
            {{else}}
                {{$linkTitle := (replace (replace . "[[" "") "]]" "")}}
                {{$content = replace $content . (printf "%s%s%s%s%s%s" "<a href=\"" "/notes/" ($linkTitle | urlize) "\">" $linkTitle "</a>")}}
            {{end}}
        {{end}}

        {{/* REMOVE SOME TAGS */}}
        {{if .Params.source}}
            {{range (split "#Book,#Research" ",")}}
                {{$content = replace $content . ""}}
            {{end}}
        {{end}}

        {{$content | safeHTML}}
    </article>
    {{partial "footer.html" .}}
    <script defer>
        var blocks = document.querySelectorAll("img");
        for(let i = 0; i < blocks.length; i++){
            blocks[i].parentElement.style.listStyleType = "none";
        }
    </script>
    {{partial "analytics.html" .}}
</body>

</html>